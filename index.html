<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Player Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --grad-start:#FF7AD9;
      --grad-end:#FF3D7F;
      --accent:#FF5AC8;
      --error:#FF4D9A;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #101123;
      background-image: radial-gradient(#2b2c3f 1px, transparent 1px);
      background-size: 20px 20px;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      min-height: 100vh;
      color: #f5f5f5;
    }

    .container {
      border-radius: 22px;
      background:
        linear-gradient(#18192B, #18192B) padding-box,
        linear-gradient(90deg,var(--grad-start),var(--grad-end)) border-box;
      border: 2px solid transparent;

      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      max-width: 560px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }

    .field { margin-bottom: 12px; }
    .field label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #ddd;
      font-size: 14px;
    }
    .field label .required { color: var(--accent); font-weight: 700; }

    .field input,
    #results {
      width: 100%;
      padding: 10px;
      border: 1px solid #444;
      border-radius: 12px;
      font-size: 14px;
      background: #242537;
      color: #f5f5f5;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s, padding-left 0.2s;
    }
    .field input[type="text"] { text-transform: capitalize; }

    .field input:focus,
    #results:focus {
      border-color: var(--accent);
      background: #2b2c3f;
      box-shadow: 0 0 8px rgba(255, 90, 200, 0.55);
    }

    .error {
      border-color: var(--error) !important;
      box-shadow: 0 0 8px rgba(255, 77, 154, 0.6) !important;
    }

    .hint { font-size:12px; color:#bdbdbd; margin-top:4px; }
    .warn { color: var(--error); display:none; }

    .result-label {
      margin-top: 8px;
      margin-bottom: 6px;
      font-size: 15px;
      font-weight: 600;
      color: var(--accent);
    }

    #results {
      font-weight: 500;
      white-space: pre-wrap;
      padding: 16px 12px;
      font-family: 'Poppins', monospace;
      font-size: 14px;
      min-height: 120px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6;
      margin-bottom: 14px;
      border-radius: 12px;
    }

    .btn {
      border: none;
      color: white;
      padding: 12px;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      background: linear-gradient(90deg,var(--grad-start),var(--grad-end));
    }
    .btn:hover { filter: brightness(1.06); }

    .btn-secondary {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }
    .btn-secondary:hover { background: rgba(255,90,200,0.08); }

    .full-width { width: 100%; margin: 6px 0 10px; display: block; }

    .actions-row, .file-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .actions-row .btn, .file-row .btn { flex: 1 1 0; }

    .copy-status {
      margin-top: 6px;
      font-size: 12px;
      color: #9ad29a;
      min-height: 16px;
    }

    /* Combo (searchable dropdown with logo inside) */
    .combo { position: relative; }
    .combo input { padding: 10px; }
    .combo.has-logo input { padding-left: 42px; }

    .combo-logo {
      position: absolute;
      top: 50%; left: 10px;
      transform: translateY(-50%);
      width: 20px; height: 20px;
      border-radius: 6px;
      object-fit: contain;
      background: #18192B;
      border: 1px solid #3a3b4f;
      pointer-events: none;
      display: none;
    }
    .combo.has-logo .combo-logo { display: block; }

    .combo-panel {
      position: absolute;
      left: 0; right: 0; top: calc(100% + 6px);
      background: #242537;
      border: 1px solid #444;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      max-height: 260px;
      overflow-y: auto;
      padding: 6px;
      display: none;
      z-index: 999;
    }
    .combo.open .combo-panel { display: block; }

    .combo-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 10px; border-radius: 10px; cursor: pointer; font-size: 14px; color: #f5f5f5;
    }
    .combo-item:hover, .combo-item.active {
      background: #2b2c3f;
      outline: 1px solid var(--accent);
    }
    .combo-item img {
      width: 22px; height: 22px;
      border-radius: 6px;
      object-fit: contain;
      background: #18192B;
      border: 1px solid #3a3b4f;
    }

    /* Sliders */
    .range-row {
      display: grid;
      grid-template-columns: 1fr 70px;
      gap: 10px;
      align-items: center;
    }
    input[type="range"]{
      accent-color: #ff5ac8;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Player Data Input</h2>

    <!-- Basic fields -->
    <div class="field">
      <label for="firstName">First Name <span class="required">*</span></label>
      <input id="firstName" type="text" autocomplete="off" enterkeyhint="done" />
    </div>

    <div class="field">
      <label for="lastName">Last Name <span class="required">*</span></label>
      <input id="lastName" type="text" autocomplete="off" enterkeyhint="done" />
    </div>

    <!-- Current Club -->
    <div class="field">
      <label for="currentClub">Current Club <span class="required">*</span></label>
      <div class="combo" id="comboCurrent">
        <img id="logoCurrent" class="combo-logo" alt="">
        <input id="currentClub" type="text" placeholder="Search club…" autocomplete="off" enterkeyhint="done" />
        <div class="combo-panel"></div>
      </div>
      <div class="hint">Type to search, ↑/↓ to move, Enter to select.</div>
    </div>

    <!-- New Club -->
    <div class="field">
      <label for="newClub">New Club</label>
      <div class="combo" id="comboNew">
        <img id="logoNew" class="combo-logo" alt="">
        <input id="newClub" type="text" placeholder="Search club…" autocomplete="off" enterkeyhint="done" />
        <div class="combo-panel"></div>
      </div>
      <div class="hint">Type to search, ↑/↓ to move, Enter to select.</div>
    </div>

    <!-- Other fields -->
    <div class="field"><label for="newFirstName">New First Name</label><input id="newFirstName" type="text" autocomplete="off" enterkeyhint="done" /></div>
    <div class="field"><label for="newLastName">New Last Name</label><input id="newLastName" type="text" autocomplete="off" enterkeyhint="done" /></div>
    <div class="field"><label for="newShortName">New Short Name</label><input id="newShortName" type="text" autocomplete="off" enterkeyhint="done" /></div>

    <!-- Year with guardrails -->
    <div class="field">
      <label for="yearOfBirth">Year of Birth (4 digits)</label>
      <input id="yearOfBirth" type="text" inputmode="numeric" pattern="\d{4}" oninput="limitYear(this)" enterkeyhint="done" />
      <div id="yearWarn" class="hint warn">Year should be between 1900 and 2025.</div>
    </div>

    <!-- CA slider + number -->
    <div class="field">
      <label for="ca">CA (0–100)</label>
      <div class="range-row">
        <input id="caRange" type="range" min="0" max="100" value="0" oninput="syncRangeToNumber('caRange','ca')" />
        <input id="ca" type="number" min="0" max="100" inputmode="numeric" value="0" oninput="syncNumberToRange('ca','caRange')" />
      </div>
      <div class="hint">Converted to 0–200 in result: (a ÷ 100) × 200</div>
    </div>

    <!-- PA slider + number -->
    <div class="field">
      <label for="pa">PA (0–100)</label>
      <div class="range-row">
        <input id="paRange" type="range" min="0" max="100" value="0" oninput="syncRangeToNumber('paRange','pa')" />
        <input id="pa" type="number" min="0" max="100" inputmode="numeric" value="0" oninput="syncNumberToRange('pa','paRange')" />
      </div>
      <div class="hint">Converted to 0–200 in result: (a ÷ 100) × 200</div>
    </div>

    <!-- Results -->
    <div class="result-label">Results</div>
    <div id="results" contenteditable="true"></div>

    <!-- Buttons -->
    <button class="btn full-width" onclick="addResult()">Add Result</button>
    <div class="actions-row">
      <button class="btn" onclick="copyResults()">Copy All</button>
      <button class="btn btn-secondary" onclick="clearResults()">Clear</button>
    </div>
    <div class="file-row">
      <button class="btn btn-secondary" onclick="downloadResults()">Download .txt</button>
      <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Upload .txt</button>
      <input id="fileInput" type="file" accept=".txt,text/plain" style="display:none" />
    </div>
    <div id="copyStatus" class="copy-status"></div>
  </div>

  <script>
    const STORAGE_KEY = "playerEditorResults";
    const YEAR_MIN = 1900;
    const YEAR_MAX = 2025;

    const FALLBACK_LOGO =
      'data:image/svg+xml;utf8,' +
      encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
        <rect width="100%" height="100%" fill="#18192B"/>
        <rect x="18" y="18" width="28" height="28" rx="6" ry="6" fill="#FF5AC8"/>
      </svg>`);

    const clubs = [
      { name: "Barcelona", logo: "https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg" },
      { name: "Real Madrid", logo: "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" },
      { name: "Manchester United", logo: "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg" },
      { name: "Liverpool", logo: "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg" }
      // add more...
    ];

    /* ===== Utilities ===== */
    function capWords(str) {
      const s = String(str || "").trim();
      return s.replace(/\b([a-zA-Z])/g, (m, p1) => p1.toUpperCase());
    }

    function limitYear(el){
      el.value = el.value.replace(/\D+/g, '').slice(0, 4);
      const warn = document.getElementById('yearWarn');
      if (el.value && (Number(el.value) < YEAR_MIN || Number(el.value) > YEAR_MAX)) {
        el.classList.add('error');
        warn.style.display = 'block';
      } else {
        el.classList.remove('error');
        warn.style.display = 'none';
      }
    }

    function clamp01(n){ return Math.max(0, Math.min(100, n)); }

    function syncRangeToNumber(rangeId, numId){
      const r = document.getElementById(rangeId);
      const n = document.getElementById(numId);
      n.value = r.value;
    }
    function syncNumberToRange(numId, rangeId){
      const n = document.getElementById(numId);
      let v = parseInt(n.value || 0, 10);
      if (isNaN(v)) v = 0;
      v = clamp01(v);
      n.value = v;
      document.getElementById(rangeId).value = v;
    }

    function convertTo200Scale(v) {
      if (v === "" || isNaN(Number(v))) return "";
      const num = clamp01(Number(v));
      const scaled = Math.round((num / 100) * 200);
      return Math.max(0, Math.min(200, scaled));
    }

    function buildResult() {
      const g = id => document.getElementById(id).value.trim();

      const first = capWords(g("firstName"));
      const last  = capWords(g("lastName"));
      const currClub = capWords(g("currentClub"));
      if (!first || !last || !currClub) return "";

      const newFirst  = capWords(g("newFirstName"));
      const newLast   = capWords(g("newLastName"));
      const shortName = capWords(g("newShortName"));
      const year      = g("yearOfBirth");
      const ca        = convertTo200Scale(g("ca"));
      const pa        = convertTo200Scale(g("pa"));
      const newClub   = capWords(g("newClub"));

      return `"PLAYER" "${first}" "${last}" "${currClub}" "${newFirst}" "${newLast}" "${shortName}" "${year}" "${ca}" "${pa}" "${newClub}"`;
    }

    function addResult() {
      const resultsEl = document.getElementById("results");
      const line = buildResult();
      if (line) {
        resultsEl.textContent += (resultsEl.textContent ? "\n" : "") + line;
        resultsEl.scrollTop = resultsEl.scrollHeight; // scroll inside results only
        saveResults();
        clearAllInputs();
      } else {
        alert("Please fill in First Name, Last Name, and Current Club.");
      }
    }

    function clearResults() {
      document.getElementById("results").textContent = "";
      saveResults();
      setCopyStatus("");
    }

    function copyResults() {
      const text = document.getElementById("results").textContent.trim();
      if (text) {
        navigator.clipboard.writeText(text)
          .then(() => setCopyStatus("Copied all results ✅"))
          .catch(err => alert("Copy failed: " + err));
      }
    }

    function downloadResults(){
      const txt = document.getElementById('results').textContent || "";
      const blob = new Blob([txt], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'player-results.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('fileInput').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const incoming = String(reader.result || "").replace(/\r\n/g,"\n").trim();
        if (!incoming) return;
        const replace = confirm("Replace current results with file content?\nPress OK to REPLACE, Cancel to APPEND.");
        const el = document.getElementById('results');
        if (replace) el.textContent = incoming;
        else el.textContent += (el.textContent ? "\n" : "") + incoming;
        saveResults();
        setCopyStatus(replace ? "Results replaced from file." : "Results appended from file.");
        e.target.value = ""; // reset
      };
      reader.readAsText(file);
    });

    function setCopyStatus(msg) { document.getElementById("copyStatus").textContent = msg; }
    function saveResults() { localStorage.setItem(STORAGE_KEY, document.getElementById("results").textContent); }
    function loadResults() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) document.getElementById("results").textContent = saved;
    }

    function clearAllInputs() {
      const ids = [
        "firstName","lastName","currentClub","newClub",
        "newFirstName","newLastName","newShortName",
        "yearOfBirth","ca","pa","caRange","paRange"
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'range' || el.type === 'number' || el.type === 'text') {
          if (id === 'ca' || id === 'pa' || id === 'caRange' || id === 'paRange') el.value = 0;
          else el.value = "";
        }
      });
      document.getElementById("comboCurrent").classList.remove("has-logo");
      document.getElementById("comboNew").classList.remove("has-logo");
      document.getElementById('yearWarn').style.display = 'none';
      document.getElementById('yearOfBirth').classList.remove('error');
    }

    /* ===== Searchable dropdown with square logo inside input ===== */
    function initCombo(comboId, inputId, logoId) {
      const combo = document.getElementById(comboId);
      const input = document.getElementById(inputId);
      const logo  = document.getElementById(logoId);
      const panel = combo.querySelector(".combo-panel");

      const FALLBACK_LOGO =
        'data:image/svg+xml;utf8,' +
        encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
          <rect width="100%" height="100%" fill="#18192B"/>
          <rect x="18" y="18" width="28" height="28" rx="6" ry="6" fill="#FF5AC8"/>
        </svg>`);

      let visibleItems = [];
      let activeIndex = -1;

      function open() { combo.classList.add("open"); }
      function close() { combo.classList.remove("open"); activeIndex = -1; }
      function isOpen() { return combo.classList.contains("open"); }

      function filter(q) {
        const query = (q || "").toLowerCase().trim();
        if (!query) return clubs.slice(0, 50);
        return clubs.filter(c => c.name.toLowerCase().includes(query)).slice(0, 100);
      }

      function render(list) {
        panel.innerHTML = "";
        visibleItems = list;

        if (list.length === 0) {
          const empty = document.createElement("div");
          empty.className = "combo-item";
          empty.style.opacity = "0.7";
          empty.textContent = "No matches";
          panel.appendChild(empty);
          return;
        }

        list.forEach((club, idx) => {
          const item = document.createElement("div");
          item.className = "combo-item";
          item.dataset.index = idx;

          const img = document.createElement("img");
          img.src = club.logo || FALLBACK_LOGO;
          img.alt = club.name;
          img.onerror = () => { img.src = FALLBACK_LOGO; };

          const span = document.createElement("span");
          span.textContent = club.name;

          item.append(img, span);

          item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            select(idx);
          });

          panel.appendChild(item);
        });
      }

      function select(idx) {
        const club = visibleItems[idx];
        if (!club) return;
        input.value = club.name;
        logo.src = club.logo || FALLBACK_LOGO;
        logo.onerror = () => { logo.src = FALLBACK_LOGO; };
        combo.classList.add("has-logo");
        close();
      }

      function moveActive(delta) {
        if (!isOpen()) open();
        const items = panel.querySelectorAll(".combo-item");
        if (items.length === 0) return;
        activeIndex = (activeIndex + delta + items.length) % items.length;
        items.forEach(el => el.classList.remove("active"));
        const activeEl = items[activeIndex];
        activeEl.classList.add("active");

        const panelRect = panel.getBoundingClientRect();
        const itemRect  = activeEl.getBoundingClientRect();
        if (itemRect.top < panelRect.top) panel.scrollTop -= (panelRect.top - itemRect.top);
        if (itemRect.bottom > panelRect.bottom) panel.scrollTop += (itemRect.bottom - panelRect.bottom);
      }

      input.addEventListener("focus", () => {
        render(filter(input.value));
        open();
      });

      input.addEventListener("input", () => {
        if (input.value.trim() === "") combo.classList.remove("has-logo");
        render(filter(input.value));
        open();
      });

      input.addEventListener("keydown", (e) => {
        if (!isOpen() && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
          render(filter(input.value));
          open();
        }
        switch (e.key) {
          case "ArrowDown": e.preventDefault(); moveActive(1); break;
          case "ArrowUp":   e.preventDefault(); moveActive(-1); break;
          case "Enter":
            if (isOpen()) {
              e.preventDefault();
              if (activeIndex >= 0) select(activeIndex);
              else if (visibleItems.length > 0) select(0);
            }
            break;
          case "Escape": close(); break;
        }
      });

      document.addEventListener("click", (e) => {
        if (!com
