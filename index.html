<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Player Data Input</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Poppins font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* THEME TOKENS */
    :root {
      /* Dark (default) */
      --bg: #101123;
      --bg-pattern: #2b2c3f;
      --panel-bg: #18192B;
      --input-bg: #242537;
      --border: #444;
      --text: #f5f5f5;
      --muted: #bdbdbd;

      --grad-start:#FF7AD9;
      --grad-end:#FF3D7F;
      --accent:#FF5AC8;
      --error:#FF4D9A;
      --icon:#ff9bd9;

      --outline-soft: rgba(255,90,200,0.16);
      --focus-glow: rgba(255,90,200,0.55);
      --empty-bg:#202233;

      --toggle-track:#202233;
      --toggle-thumb:#fff;
      --toggle-shadow: rgba(0,0,0,0.35);
    }
    /* Light theme */
    [data-theme="light"] {
      --bg: #E5E6FA;
      --bg-pattern: rgba(26,27,46,0.08);
      --panel-bg: #ffffff;
      --input-bg: #F4F5FF;
      --border: #cfd1f4;
      --text: #1a1b2e;
      --muted: #585b8a;

      --outline-soft: rgba(255,90,200,0.22);
      --focus-glow: rgba(255,90,200,0.45);
      --empty-bg:#F1F2FF;

      --toggle-track:#e7e8ff;
      --toggle-thumb:#ffffff;
      --toggle-shadow: rgba(50,50,93,0.2);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg);
      background-image: radial-gradient(var(--bg-pattern) 1px, transparent 1px);
      background-size: 20px 20px;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      min-height: 100vh;
      color: var(--text);
      transition: background-color .25s ease, color .25s ease;
    }

    .container {
      border-radius: 22px;
      background:
        linear-gradient(var(--panel-bg), var(--panel-bg)) padding-box,
        linear-gradient(90deg,var(--grad-start),var(--grad-end)) border-box;
      border: 2px solid transparent;
      padding: 16px 16px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      max-width: 520px; /* mobile default */
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: background .25s ease, box-shadow .25s ease, max-width .25s ease;
    }

    /* Header / theme toggle */
    .header { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:2px 2px 8px; }
    h2 { margin:0; font-size:22px; font-weight:600; color:var(--text); }

    .theme-toggle { border:0; background:transparent; padding:0; cursor:pointer; }
    .toggle-track {
      position: relative; width:56px; height:28px; border-radius:999px;
      background:var(--toggle-track);
      box-shadow:0 2px 8px var(--toggle-shadow) inset, 0 2px 6px var(--toggle-shadow);
      padding:2px; display:inline-block;
      transition: background .25s ease, box-shadow .25s ease;
    }
    .toggle-thumb {
      position:absolute; top:2px; left:2px; width:24px; height:24px; border-radius:999px;
      background:var(--toggle-thumb); box-shadow:0 2px 6px rgba(0,0,0,.25);
      transition: transform .28s cubic-bezier(.2,.8,.2,1);
    }
    .toggle-icon { position:absolute; top:50%; transform:translateY(-50%); width:14px; height:14px; opacity:.9; }
    .toggle-icon.moon { right:8px; color:#8ea0ff; }
    .toggle-icon.sun  { left:8px;  color:#ffb84d; }
    .toggle-icon svg { width:14px; height:14px; display:block; }
    [data-theme="light"] .toggle-thumb { transform: translateX(28px); }

    /* Inputs */
    .field { margin-bottom:10px; }
    .field-label {
      display:flex; align-items:center; gap:8px;
      margin-bottom:6px; font-weight:500; color:var(--text); font-size:14px; opacity:.9;
    }
    .field .required { color:var(--accent); font-weight:700; }

    .field input {
      width:100%; padding:10px; border:1px solid var(--border); border-radius:12px;
      font-size:16px; background:var(--input-bg); color:var(--text); outline:none;
      transition: border-color .2s, box-shadow .2s, background .2s, padding-left .2s;
    }
    .field input[type="text"] { text-transform: capitalize; }
    .field input:focus { border-color:var(--accent); background:rgba(43,44,63,.12); box-shadow:0 0 8px var(--focus-glow); }

    .error { border-color:var(--error)!important; box-shadow:0 0 8px rgba(255,77,154,0.6)!important; }

    /* Compact help bubble (ALWAYS ABOVE) */
    .help {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px; height: 18px;
      border-radius: 50%;
      border: 1px solid var(--accent);
      color: var(--accent);
      font-size: 12px; line-height: 18px;
      cursor: pointer; user-select: none;
      transition: background .2s, color .2s, transform .1s;
    }
    .help:active { transform: scale(0.96); }

    .help .tip {
      position: absolute;
      bottom: calc(100% + 10px);     /* always above */
      left: 0;
      min-width: 220px;
      max-width: 320px;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.35;
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      z-index: 4000;                 /* above inputs & dropdown */
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-6px) scale(.98);
      transition:
        opacity .18s ease,
        transform .18s cubic-bezier(.2,.8,.2,1),
        visibility 0s linear .18s;   /* hide after fade-out */
    }
    .help .tip::before{
      content:""; position:absolute; left:12px; bottom:-6px;
      border-left:6px solid transparent; border-right:6px solid transparent; border-top:6px solid var(--border);
    }
    .help.open .tip {
      visibility: visible;
      opacity: 1;
      transform: translateY(0) scale(1);
      transition:
        opacity .22s ease,
        transform .22s cubic-bezier(.2,.8,.2,1),
        visibility 0s;
      pointer-events: auto;
    }

    /* Required-field feedback */
    .field.req .req-msg { display:block; }
    .req-msg { display:none; font-size:12px; color:var(--error); margin-top:6px; }
    .shake { animation: shake 240ms ease-in-out 0s 1; }
    @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 50%{transform:translateX(5px);} 75%{transform:translateX(-3px);} }

    /* Results */
    .result-label { margin-top:0; margin-bottom:6px; font-size:15px; font-weight:600; color:var(--accent); }

    #results {
      padding:16px; border:1px solid var(--border); border-radius:16px; background:var(--input-bg);
      min-height:160px; max-height:300px; overflow-y:auto;
      display:flex; flex-direction:column; gap:12px; position:relative; margin-bottom:14px;
      transition: background .25s ease, border-color .25s ease;
    }
    #results.empty { justify-content:center; }
    .empty-state {
      display:none; border:1px solid var(--border); background:var(--empty-bg); color:var(--muted);
      border-radius:16px; height:72px; padding:0 16px; align-items:center; justify-content:center; text-align:center;
    }
    #results.empty .empty-state { display:flex; }

    .res-line { display:flex; align-items:flex-start; gap:8px; padding:10px 12px; border-radius:14px; background:var(--input-bg); outline:1px solid var(--outline-soft); }
    .res-text { flex:1 1 auto; min-height:18px; line-height:1.6; font-family:'Poppins', monospace; font-size:14px; color:var(--text); outline:none; }
    .res-text[contenteditable="true"]:focus { background:rgba(43,44,63,.12); box-shadow: inset 0 0 0 1px var(--accent), 0 0 8px rgba(255,90,200,0.35); border-radius:8px; padding:2px 4px; }

    .icon-btn { border:none; background:transparent; color:var(--icon); padding:6px 8px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; }
    .icon-btn:hover { background:rgba(255,90,200,0.1); }
    .icon-btn svg { width:18px; height:18px; display:block; }

    .btn { border:none; color:white; padding:12px; border-radius:14px; font-size:14px; font-weight:600; cursor:pointer; text-align:center; background:linear-gradient(90deg,var(--grad-start),var(--grad-end)); }
    .btn:hover { filter:brightness(1.06); }
    .btn.cta { padding:16px; font-size:16px; border-radius:16px; }
    .btn-secondary { background:transparent; border:2px solid var(--accent); color:var(--accent); }
    .btn-secondary:hover { background:rgba(255,90,200,0.08); }
    .full-width { width:100%; margin:6px 0 10px; display:block; }
    .actions-row { display:flex; gap:10px; flex-wrap:wrap; }
    .actions-row .btn { flex:1 1 0; }
    .copy-status { margin-top:6px; font-size:12px; color:#9ad29a; min-height:16px; }

    /* Combo (dropdown with square logo) */
    .combo { position:relative; }
    .combo input { padding:10px; }
    .combo.has-logo input { padding-left:36px; }
    .combo-logo {
      position:absolute; top:50%; left:10px; transform:translateY(-50%);
      width:18px; height:18px; border-radius:4px; object-fit:contain; background:transparent; border:0; box-shadow:none; display:none; pointer-events:none;
    }
    .combo.has-logo .combo-logo { display:block; }
    .combo-panel {
      position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:var(--input-bg); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.35); max-height:260px; overflow-y:auto; padding:6px; display:none; z-index:3000;
    }
    .combo.open .combo-panel { display:block; }
    .combo-item { display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:16px; color:var(--text); }
    .combo-item:hover, .combo-item.active { background:rgba(43,44,63,.12); outline:1px solid var(--accent); }
    .combo-item img { width:22px; height:22px; border-radius:4px; object-fit:contain; background:transparent; border:0; box-shadow:none; }

    /* Desktop layout: two columns, sticky results */
    @media (min-width: 960px) {
      .container { max-width:1120px; padding:20px 22px 24px; }
      .content-grid {
        display:grid; grid-template-columns:minmax(0,1fr) 420px; gap:22px; align-items:start;
      }
      .results-col { position:sticky; top:12px; height:calc(100vh - 120px); display:flex; flex-direction:column; }
      .results-col #results { flex:1 1 auto; min-height:0; max-height:none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Player Data Input</h2>

      <!-- Theme toggle -->
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
        <span class="toggle-track">
          <span class="toggle-icon sun" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
            </svg>
          </span>
          <span class="toggle-icon moon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </span>
          <span class="toggle-thumb"></span>
        </span>
      </button>
    </div>

    <!-- Grid: form (left) + results (right) -->
    <div class="content-grid">
      <section class="form-col">
        <div class="field" id="field-first">
          <div class="field-label">
            <label for="firstName">First Name <span class="required">*</span></label>
          </div>
          <input id="firstName" type="text" autocomplete="off" />
          <div class="req-msg" id="msg-first">This field is required.</div>
        </div>

        <div class="field" id="field-last">
          <div class="field-label">
            <label for="lastName">Last Name <span class="required">*</span></label>
          </div>
          <input id="lastName" type="text" autocomplete="off" />
          <div class="req-msg" id="msg-last">This field is required.</div>
        </div>

        <div class="field" id="field-current">
          <div class="field-label">
            <label for="currentClub">Current Club <span class="required">*</span></label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Contracted club only. Use full official name (e.g., “Manchester United”). If unattached, enter “free”.</span>
            </span>
          </div>
          <div class="combo" id="comboCurrent">
            <img id="logoCurrent" class="combo-logo" alt="">
            <input id="currentClub" type="text" placeholder="Search club…" autocomplete="off" />
            <div class="combo-panel"></div>
          </div>
          <div class="req-msg" id="msg-current">This field is required.</div>
        </div>

        <div class="field">
          <div class="field-label">
            <label for="newClub">New Club</label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Use the full official name. Type to search, use ↑/↓ to move, Enter to select.</span>
            </span>
          </div>
          <div class="combo" id="comboNew">
            <img id="logoNew" class="combo-logo" alt="">
            <input id="newClub" type="text" placeholder="Search club…" autocomplete="off" />
            <div class="combo-panel"></div>
          </div>
        </div>

        <div class="field">
          <div class="field-label">
            <label for="newFirstName">New First Name</label>
          </div>
          <input id="newFirstName" type="text" autocomplete="off" />
        </div>

        <div class="field">
          <div class="field-label">
            <label for="newLastName">New Last Name</label>
          </div>
          <input id="newLastName" type="text" autocomplete="off" />
        </div>

        <div class="field">
          <div class="field-label">
            <label for="newShortName">New Short Name</label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Common/short name (e.g., Neymar/Willian). You can add one; you can’t remove an existing one in-game.</span>
            </span>
          </div>
          <input id="newShortName" type="text" autocomplete="off" />
        </div>

        <div class="field">
          <div class="field-label">
            <label for="yearOfBirth">Year of Birth</label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Must be a 4-digit year. Player must be at least 16 at game start.</span>
            </span>
          </div>
          <input id="yearOfBirth" type="text" inputmode="numeric" pattern="\d{4}" />
          <div id="yearWarn" class="req-msg">Year should be between 1900 and 2025.</div>
        </div>

        <div class="field">
          <div class="field-label">
            <label for="ca">CA</label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Current Ability. Enter 0–100 here; we convert to 0–200 (max 200).</span>
            </span>
          </div>
          <input id="ca" type="number" min="0" max="100" inputmode="numeric" />
        </div>

        <div class="field">
          <div class="field-label">
            <label for="pa">PA</label>
            <span class="help" tabindex="0" role="button" aria-expanded="false">
              i
              <span class="tip">Potential Ability (past or future). Enter 0–100 here; we convert to 0–200 (max 200).</span>
            </span>
          </div>
          <input id="pa" type="number" min="0" max="100" inputmode="numeric" />
        </div>
      </section>

      <section class="results-col">
        <div class="result-label">Results</div>
        <div id="results" class="empty">
          <div class="empty-state">No results yet</div>
        </div>

        <button class="btn full-width cta" id="addBtn">Add Result</button>
        <div class="actions-row">
          <button class="btn" id="copyBtn">Copy All</button>
          <button class="btn btn-secondary" id="clearBtn">Clear</button>
        </div>
        <div id="copyStatus" class="copy-status"></div>
      </section>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      const STORAGE_KEY = "playerEditorResults";
      const THEME_KEY = "playerEditorTheme";
      const YEAR_MIN = 1900, YEAR_MAX = 2025;

      const clubs = [
        { name: "Barcelona", logo: "https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg" },
        { name: "Real Madrid", logo: "https://upload.wikimedia.org/wikipedia/en/5/56/Real_Madrid_CF.svg" },
        { name: "Manchester United", logo: "https://upload.wikimedia.org/wikipedia/en/7/7a/Manchester_United_FC_crest.svg" },
        { name: "Liverpool", logo: "https://upload.wikimedia.org/wikipedia/en/0/0c/Liverpool_FC.svg" }
      ];

      /* Theme */
      const root = document.documentElement;
      function applyTheme(theme){ root.setAttribute('data-theme', theme); localStorage.setItem(THEME_KEY, theme); }
      function initTheme(){ const saved = localStorage.getItem(THEME_KEY); applyTheme(saved==='light'||saved==='dark'?saved:'dark'); }

      /* Helpers */
      const $ = (id) => document.getElementById(id);
      const resultsEl = $('results');
      const addBtn = $('addBtn');

      function capWords(str){ return String(str||'').trim().replace(/\b([a-zA-Z])/g,(m,p)=>p.toUpperCase()); }
      function clamp01(n){ return Math.max(0, Math.min(100, n)); }
      function convertTo200Scale(v){ if(v===""||isNaN(+v))return ""; const n=clamp01(+v); return Math.round((n/100)*200); }
      function setCopyStatus(msg){ $('copyStatus').textContent = msg || ''; }

      function updateEmptyState(){
        const hasLines = resultsEl.querySelector('.res-line') !== null;
        resultsEl.classList.toggle('empty', !hasLines);
        addBtn.classList.toggle('cta', !hasLines);
      }

      function trashSVG(){ return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14H6L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4h6v2"></path></svg>`; }
      function copySVG(){ return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15V5a2 2 0 0 1 2-2h10"></path></svg>`; }

      function copyToClipboard(text){
        if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
        return new Promise((resolve, reject) => {
          try { const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); resolve(); }
          catch(e){ reject(e); }
        });
      }

      /* Results rendering */
      function makeLineEl(text){
        const line = document.createElement('div'); line.className = 'res-line';
        const span = document.createElement('span'); span.className='res-text'; span.contentEditable='true'; span.textContent=text;
        const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.title='Copy line'; copyBtn.setAttribute('aria-label','Copy line'); copyBtn.innerHTML = copySVG();
        const delBtn  = document.createElement('button'); delBtn.className='icon-btn';  delBtn.title='Delete line'; delBtn.setAttribute('aria-label','Delete line'); delBtn.innerHTML  = trashSVG();

        copyBtn.addEventListener('click', () => { copyToClipboard(span.textContent.trim()).then(()=>setCopyStatus('Copied line ✅')).catch(err=>alert('Copy failed: '+err)); });
        delBtn.addEventListener('click',  () => { line.remove(); saveResults(); updateEmptyState(); });
        span.addEventListener('input', () => saveResults());

        line.append(span, copyBtn, delBtn);
        return line;
      }
      function appendResultLine(text){ resultsEl.appendChild(makeLineEl(text)); resultsEl.scrollTop = resultsEl.scrollHeight; saveResults(); updateEmptyState(); }
      function getAllLines(){ return Array.from(resultsEl.querySelectorAll('.res-text')).map(el => el.textContent); }
      function renderFromLines(lines){ resultsEl.querySelectorAll('.res-line').forEach(el=>el.remove()); lines.forEach(t=>{ if(t&&String(t).trim()!=='') resultsEl.appendChild(makeLineEl(t)); }); updateEmptyState(); }
      function saveResults(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(getAllLines())); }
      function loadResults(){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw){updateEmptyState();return;} let lines=[]; try{const p=JSON.parse(raw); lines=Array.isArray(p)?p:String(raw).split(/\n/);}catch{lines=String(raw).split(/\n/);} renderFromLines(lines); }

      /* Build result */
      function buildResult() {
        const g = id => ($(id)?.value || "").trim();
        const first = capWords(g("firstName"));
        const last  = capWords(g("lastName"));
        const curr  = capWords(g("currentClub"));
        if (!first || !last || !curr) return "";
        const newFirst  = capWords(g("newFirstName"));
        const newLast   = capWords(g("newLastName"));
        const shortName = capWords(g("newShortName"));
        const year      = g("yearOfBirth");
        const ca        = convertTo200Scale(g("ca"));
        const pa        = convertTo200Scale(g("pa"));
        const newClub   = capWords(g("newClub"));
        return `"PLAYER" "${first}" "${last}" "${curr}" "${newFirst}" "${newLast}" "${shortName}" "${year}" "${ca}" "${pa}" "${newClub}"`;
      }

      /* Required fields */
      const requiredInputs = ['firstName','lastName','currentClub'];
      function markReqFor(inputEl){ const fieldEl=inputEl.closest('.field'); if(!fieldEl) return; fieldEl.classList.add('req','shake'); setTimeout(()=>fieldEl.classList.remove('shake'),260); }
      function clearReqFor(inputEl){ const fieldEl=inputEl.closest('.field'); if(!fieldEl) return; fieldEl.classList.remove('req'); }
      function validateRequired(show=false){
        const miss=[]; requiredInputs.forEach(id=>{ const el=$(id); if(!el.value.trim()) miss.push(el); });
        if(show && miss.length){ miss.forEach(el=>markReqFor(el)); const f=miss[0]; f.scrollIntoView({behavior:'smooth',block:'center'}); setTimeout(()=>f.focus(),220); }
        return miss.length===0;
      }

      /* Year & numbers */
      function limitYear(el){
        el.value = el.value.replace(/\D+/g, '').slice(0, 4);
        const warn = $('yearWarn'); const val = el.value;
        if (val && (val.length !== 4 || +val < YEAR_MIN || +val > YEAR_MAX)) { el.classList.add('error'); warn.style.display='block'; }
        else { el.classList.remove('error'); warn.style.display='none'; }
      }
      function isYearValidOrEmpty(){
        const val = ($('yearOfBirth').value || '').trim();
        if (!val) return true;
        if (val.length !== 4) return false;
        const n = +val; return !(isNaN(n) || n < YEAR_MIN || n > YEAR_MAX);
      }
      function clampPercent(el){ if (el.value === "") return; let n=parseInt(el.value,10); if(isNaN(n)){el.value=""; return;} el.value=Math.max(0, Math.min(100, n)); }

      /* Combo (searchable dropdown) */
      function initCombo(comboId, inputId, logoId) {
        const combo = $(comboId), input = $(inputId), logo = $(logoId), panel = combo.querySelector(".combo-panel");
        let visible = [], activeIndex = -1;
        const open = () => combo.classList.add("open");
        const close = () => { combo.classList.remove("open"); activeIndex = -1; };
        const isOpen = () => combo.classList.contains("open");

        function filter(q){
          const query = (q || "").toLowerCase().trim();
          if (!query) return clubs.slice(0, 50);
          return clubs.filter(c => c.name.toLowerCase().includes(query)).slice(0, 100);
        }
        function render(list){
          panel.innerHTML = ""; visible = list;
          if (!list.length){ const d=document.createElement("div"); d.className="combo-item"; d.style.opacity=".7"; d.textContent="No matches"; panel.appendChild(d); return; }
          list.forEach((club, idx) => {
            const item = document.createElement("div"); item.className="combo-item"; item.dataset.index=idx;
            const img = document.createElement("img");
            if (club.logo) { img.src = club.logo; img.alt = club.name; img.onerror=()=>{img.style.display='none';}; }
            else { img.style.display='none'; }
            const span = document.createElement("span"); span.textContent = club.name;
            item.append(img, span);
            item.addEventListener("mousedown",(e)=>{ e.preventDefault(); select(idx); });
            panel.appendChild(item);
          });
        }
        function select(idx){
          const club = visible[idx]; if (!club) return;
          input.value = club.name;
          if (club.logo) { logo.src = club.logo; combo.classList.add("has-logo"); logo.style.display='block'; logo.onerror=()=>{combo.classList.remove("has-logo"); logo.style.display='none';}; }
          else { combo.classList.remove("has-logo"); logo.style.display='none'; }
          close(); clearReqFor(input);
        }
        function moveActive(delta){
          if (!isOpen()) open();
          const items = panel.querySelectorAll(".combo-item"); if (!items.length) return;
          activeIndex = (activeIndex + delta + items.length) % items.length;
          items.forEach(el => el.classList.remove("active"));
          const a=items[activeIndex]; a.classList.add("active");
          const pr = panel.getBoundingClientRect(), ir = a.getBoundingClientRect();
          if (ir.top < pr.top) panel.scrollTop -= (pr.top - ir.top);
          if (ir.bottom > pr.bottom) panel.scrollTop += (ir.bottom - pr.bottom);
        }

        input.addEventListener("focus", () => { render(filter(input.value)); open(); });
        input.addEventListener("input", () => {
          if (input.value.trim()==="") { combo.classList.remove("has-logo"); logo.style.display='none'; }
          render(filter(input.value)); open(); clearReqFor(input);
        });
        input.addEventListener("keydown", (e) => {
          if (!isOpen() && (e.key==="ArrowDown"||e.key==="ArrowUp")) { render(filter(input.value)); open(); }
          switch (e.key) {
            case "ArrowDown": e.preventDefault(); moveActive(1); break;
            case "ArrowUp":   e.preventDefault(); moveActive(-1); break;
            case "Enter":     if (isOpen()) { e.preventDefault(); if (activeIndex>=0) select(activeIndex); else if (visible.length) select(0); } break;
            case "Escape":    close(); break;
          }
        });
        document.addEventListener("click", (e) => { if (!combo.contains(e.target)) close(); });
      }

      /* Help bubbles: fixed ABOVE + variable duration + smooth anim */
      function initHelpBubbles(){
        const helps = document.querySelectorAll('.help');
        const timers = new WeakMap();

        function close(h){
          if(!h) return;
          h.classList.remove('open');
          h.setAttribute('aria-expanded','false');
          if (timers.get(h)) clearTimeout(timers.get(h));
        }
        function tipDuration(tipEl){
          const len = (tipEl.textContent || '').trim().length;
          // ~25ms per char, min 1400ms, max 5200ms
          return Math.max(1400, Math.min(5200, 25 * len));
        }
        function openTip(h){
          const tip = h.querySelector('.tip');
          h.classList.add('open'); h.setAttribute('aria-expanded','true');
          if (timers.get(h)) clearTimeout(timers.get(h));
          timers.set(h, setTimeout(() => close(h), tipDuration(tip)));
        }

        helps.forEach(h => {
          h.addEventListener('click', (e) => { e.stopPropagation(); openTip(h); });
          h.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTip(h); }
          });
        });

        document.addEventListener('click', () => { helps.forEach(close); }, { capture:true });
      }

      /* Actions */
      function addResult(){
        if (!validateRequired(true)) return;
        if (!isYearValidOrEmpty()) { $('yearOfBirth').classList.add('error'); $('yearWarn').style.display='block'; alert('Year must be a 4-digit number between 1900 and 2025 (or leave it empty).'); return; }
        const line = buildResult(); if (!line) return;
        appendResultLine(line);
        ["firstName","lastName","currentClub","newClub","newFirstName","newLastName","newShortName","yearOfBirth","ca","pa"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
        ["comboCurrent","comboNew"].forEach(id=>{ const c=$(id); if(c){ c.classList.remove("has-logo"); const img=c.querySelector(".combo-logo"); if(img) img.style.display="none"; }});
        $('yearWarn').style.display='none'; $('yearOfBirth').classList.remove('error');
      }
      function copyResults(){ const text=getAllLines().join('\n').trim(); if(!text) return; copyToClipboard(text).then(()=>{ setCopyStatus('Copied all results ✅'); }).catch(err=>alert('Copy failed: '+err)); }
      function clearResults(){ resultsEl.querySelectorAll('.res-line').forEach(el=>el.remove()); saveResults(); setCopyStatus(''); updateEmptyState(); }

      /* Init */
      document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', () => {
          const next = (root.getAttribute('data-theme') === 'light') ? 'dark' : 'light';
          applyTheme(next);
        });

        loadResults();
        initCombo("comboCurrent", "currentClub", "logoCurrent");
        initCombo("comboNew",     "newClub",     "logoNew");
        initHelpBubbles();

        $('yearOfBirth').addEventListener('input', e => limitYear(e.target));
        $('ca').addEventListener('input', e => clampPercent(e.target));
        $('pa').addEventListener('input', e => clampPercent(e.target));

        ['firstName','lastName','currentClub'].forEach(id => {
          $(id).addEventListener('input', e => { if (e.target.value.trim()) clearReqFor(e.target); });
        });

        $('addBtn').addEventListener('click', addResult);
        $('copyBtn').addEventListener('click', copyResults);
        $('clearBtn').addEventListener('click', clearResults);

        document.addEventListener('keydown', (e) => {
          if (e.key !== 'Enter') return;
          const active = document.activeElement;
          const editing = active && active.classList && active.classList.contains('res-text') && active.isContentEditable;
          const comboOpen = document.querySelector('.combo.open');
          if (!editing && !comboOpen) { e.preventDefault(); addResult(); }
        });

        updateEmptyState();
      });
    })();
  </script>
</body>
</html>
