<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clubs CSV → JSON Maker</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#101123;--card:#18192B;--ink:#f5f5f5;--muted:#a9a9c4;--border:#2e2f45;
    --grad1:#FF7AD9;--grad2:#FF3D7F;--accent:#FF5AC8;--ok:#76d39b;--warn:#ffb454;--bad:#ff4d9a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center;min-height:100vh;padding:18px}
  .wrap{width:100%;max-width:980px;background:linear-gradient(var(--card),var(--card)) padding-box,
                               linear-gradient(90deg,var(--grad1),var(--grad2)) border-box;
        border:2px solid transparent;border-radius:20px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:16px;}
  h1{margin:6px 6px 4px;font-size:22px}
  .sub{margin:0 6px 14px;color:var(--muted);font-size:13px}
  .grid{display:grid;gap:16px}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:#1f2136;border:1px solid var(--border);border-radius:14px;padding:12px}
  label{font-size:13px;color:var(--muted);display:block;margin:4px 0 6px}
  textarea{width:100%;min-height:220px;border-radius:12px;border:1px solid var(--border);background:#242537;color:var(--ink);padding:12px;font-size:14px;resize:vertical;outline:none}
  textarea:focus{box-shadow:0 0 0 2px rgba(255,90,200,.35)}
  input[type="text"], select{width:100%;border-radius:10px;border:1px solid var(--border);background:#242537;color:var(--ink);padding:10px;font-size:14px;outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:none;border-radius:14px;padding:12px 16px;font-weight:600;color:#fff;cursor:pointer;background:linear-gradient(90deg,var(--grad1),var(--grad2))}
  .btn.secondary{background:transparent;border:2px solid var(--accent);color:var(--accent)}
  .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  pre{margin:0;height:260px;overflow:auto;background:#242537;border:1px solid var(--border);border-radius:12px;padding:12px;white-space:pre-wrap;word-break:break-word;font-size:13px}
  .note{font-size:12px;color:var(--muted)}
  .good{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#242537;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
  .progress{height:8px;background:#242537;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2))}
  .guide{background:#232540;border:1px dashed var(--border);border-radius:12px;padding:10px;margin:8px 0 2px}
  .guide h3{margin:2px 0 8px;font-size:14px}
  .guide ol{margin:0 0 0 18px;padding:0}
  .guide li{margin:6px 0;font-size:13px}
  .errors{margin-top:10px}
  .errors li{margin:4px 0;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Clubs CSV → JSON Maker</h1>
    <p class="sub">Paste/upload CSV, optionally load your existing <code>clubs.json</code>, convert & merge, auto-fetch crests, then download.</p>

    <div class="guide">
      <h3>Quick guide</h3>
      <ol>
        <li>CSV can be <b>with or without header</b>. If no header, we assume <code>common, official, logo, aliases</code>. Optional: <code>wiki</code> (Wikipedia title or Wikidata QID).</li>
        <li>(Optional) Load your current <code>clubs.json</code> to merge with the new rows.</li>
        <li>Tick <b>auto-fetch</b>. The tool tries: <b>wiki hint → aliases (in order) → official → common</b>.  
            Default is **crest-only via Wikidata P154**; we won’t use random photos.</li>
        <li>Download the merged <b>clubs.json</b> and commit it.</li>
      </ol>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="chip">Default header: <code>common, official, logo, aliases</code> (+ optional <code>wiki</code>)</div>
          <input id="file" type="file" accept=".csv" />
        </div>

        <label for="csv">Paste CSV here</label>
        <textarea id="csv" placeholder='No header example:
Arsenal,Arsenal,,Gunners|Arsenal FC
Aston Villa,Aston Villa,,Villa

Header example:
common,official,logo,aliases,wiki
Arsenal,Arsenal,,Gunners,Arsenal F.C.
Aston Villa,Aston Villa,,,Q18772'></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="convertBtn">Convert → JSON</button>
          <button class="btn ghost" id="sampleBtn" title="Insert sample CSV">Insert sample</button>
        </div>

        <div style="margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:12px">
          <label class="row" style="gap:8px;margin:0">
            <input type="checkbox" id="wikicb" checked> Try to <b>auto-fetch missing logos</b>
          </label>
          <div id="wkBox" style="display:block;margin-top:10px">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="row" style="gap:12px;align-items:center">
                <label class="row" style="gap:8px;margin:0">
                  <input type="checkbox" id="crestOnly" checked>
                  <span class="note">Crest-only (Wikidata <code>P154</code>); don’t use photos</span>
                </label>
                <div class="chip"><span id="wkCount">0</span> to fetch</div>
              </div>
              <div class="note">Only rows with empty <code>logo</code> are fetched.</div>
            </div>
            <div class="progress" style="margin-top:8px"><div class="bar" id="wkBar"></div></div>
          </div>
        </div>

        <ul id="errors" class="errors"></ul>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <label style="margin:0">Preview (<span id="count">0</span> clubs)</label>
          <div class="row">
            <button class="btn secondary" id="copyBtn" disabled>Copy JSON</button>
            <button class="btn secondary" id="downloadBtn" disabled>Download clubs.json</button>
          </div>
        </div>
        <pre id="out">// JSON will appear here…</pre>
      </div>

      <!-- LOAD BASE JSON -->
      <div class="card">
        <h3 style="margin:2px 0 8px;font-size:16px">Load existing <code>clubs.json</code> (optional)</h3>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="chip">Loaded base: <b id="baseCount">0</b> clubs</div>
          <div class="row">
            <label class="row" style="align-items:center;gap:8px;margin:0">
              <span class="note">Merge preference:</span>
              <select id="preferSelect">
                <option value="existing" selected>Prefer Existing</option>
                <option value="new">Prefer New CSV</option>
              </select>
            </label>
            <label class="row" style="align-items:center;gap:8px;margin:0">
              <input type="checkbox" id="autoMerge" checked>
              <span class="note">Auto-merge on Convert</span>
            </label>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="jsonFile" type="file" accept=".json" />
          <button class="btn secondary" id="loadJsonBtn">Load from file</button>
          <button class="btn ghost" id="clearBaseBtn" title="Forget loaded base">Clear loaded</button>
        </div>

        <label for="jsonPaste" class="note" style="margin-top:10px">…or paste JSON here</label>
        <textarea id="jsonPaste" placeholder='[
  {"common":"Barcelona","official":"FC Barcelona","logo":"https://…svg","aliases":["Barca"]},
  {"common":"Arsenal","official":"Arsenal","aliases":["Gunners"],"wiki":"Arsenal F.C."}
]'></textarea>
        <div class="row">
          <button class="btn secondary" id="loadPasteBtn">Load pasted JSON</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- CSV utils ---------- */
function parseCSV(text){
  const rows=[]; let row=[], field='', inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='"' && n==='"'){ field+='"'; i++; }
      else if(c==='\"'){ inQ=false; }
      else field+=c;
    }else{
      if(c==='\"'){ inQ=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n' || c==='\r'){
        if(c==='\r' && n==='\n') i++;
        row.push(field); rows.push(row); row=[]; field='';
      }else field+=c;
    }
  }
  row.push(field); rows.push(row);
  return rows.filter(r=>!(r.length===1 && r[0].trim()===''));
}
function splitAliases(s){ if(!s) return []; return s.split(/[|;,]/).map(x=>x.trim()).filter(Boolean); }

const ACCEPT_HEADERS = ['common','official','logo','aliases','wiki'];
const DEFAULT_HEADERS = ['common','official','logo','aliases']; // used when no header present
function looksLikeHeader(row){
  const lower = row.map(x=>x.trim().toLowerCase());
  return ACCEPT_HEADERS.some(h => lower.includes(h));
}
function toObj(headers, row, lineNo){
  const h = headers.map(x=>x.trim().toLowerCase());
  const get = (name)=>{ const idx=h.indexOf(name); return idx>=0 ? (row[idx]||'').trim() : ''; };
  const o={};
  const common = get('common');
  const official= get('official');
  const logo = get('logo');
  const aliases = splitAliases(get('aliases'));
  const wiki = get('wiki');

  if(common) o.common = common;
  if(official) o.official = official;
  if(logo) o.logo = logo;
  if(aliases.length) o.aliases = aliases;
  if(wiki) o.wiki = wiki;

  const errors=[];
  if(!common) errors.push(`Row ${lineNo}: missing "common"`);
  return {obj:o, errors};
}

/* ---------- Wikidata helpers ---------- */
function commonsFileUrl(filename, width=512){
  return 'https://commons.wikimedia.org/wiki/Special:FilePath/' +
         encodeURIComponent(filename) + (width?`?width=${width}`:'');
}
async function fetchWikidataEntity(qid){
  const url = 'https://www.wikidata.org/wiki/Special:EntityData/' + encodeURIComponent(qid) + '.json';
  const r = await fetch(url, {mode:'cors'}); if(!r.ok) return null;
  const j = await r.json();
  return j?.entities?.[qid] || null;
}
function isFootballClub(entity){
  const P31 = entity?.claims?.P31 || [];
  const ids = new Set(P31.map(c => c?.mainsnak?.datavalue?.value?.id).filter(Boolean));
  return ids.has('Q476028') || ids.has('Q847017'); // association football club / football club
}
function extractCrestP154(entity){
  const p154 = entity?.claims?.P154?.[0]?.mainsnak?.datavalue?.value; // logo image filename
  return p154 ? commonsFileUrl(p154) : null;
}

/* Resolve Wikipedia title -> Wikidata QID */
async function titleToQid(title){
  try{
    const r = await fetch('https://en.wikipedia.org/w/api.php?origin=*&action=query&prop=pageprops&format=json&titles=' +
                          encodeURIComponent(title));
    const j = await r.json();
    const page = j?.query?.pages ? Object.values(j.query.pages)[0] : null;
    return page?.pageprops?.wikibase_item || null;
  }catch(e){ return null; }
}

/* Wikidata search (for strings that aren’t QIDs or exact titles) */
async function searchWikidataItem(term){
  const url = 'https://www.wikidata.org/w/api.php?origin=*&action=wbsearchentities&search=' +
              encodeURIComponent(term) + '&language=en&type=item&limit=8&format=json';
  const r = await fetch(url); if(!r.ok) return [];
  const j = await r.json();
  return j?.search || [];
}

/* Single best-crest resolver:
   - If QID: fetch entity → P154
   - Else if string: try title→QID; else Wikidata search (football clubs only) → P154
*/
async function resolveCrest(term){
  try{
    if(!term) return null;
    // QID?
    if(/^Q\d+$/i.test(term)){
      const ent = await fetchWikidataEntity(term);
      if(ent && isFootballClub(ent)) return extractCrestP154(ent);
      return null;
    }
    // Wikipedia title → QID
    const qFromTitle = await titleToQid(term);
    if(qFromTitle){
      const ent = await fetchWikidataEntity(qFromTitle);
      if(ent && isFootballClub(ent)) return extractCrestP154(ent);
    }
    // Wikidata search → first football club with P154
    const results = await searchWikidataItem(term);
    for(const res of results){
      const ent = await fetchWikidataEntity(res.id);
      if(ent && isFootballClub(ent)){
        const crest = extractCrestP154(ent);
        if(crest) return crest;
      }
    }
  }catch(e){}
  return null;
}

/* ---------- Pretty JSON (inline arrays) ---------- */
const IND = '  ';
function esc(s){ return JSON.stringify(s); }
function isInlineArray(a){ return Array.isArray(a) && a.every(x => typeof x === 'string'); }
function fmtAny(v, lvl){
  if (isInlineArray(v)) return '[' + v.map(esc).join(', ') + ']';
  if (Array.isArray(v)) return '[\n' + v.map(x => IND.repeat(lvl+1) + fmtAny(x, lvl+1)).join(',\n') + '\n' + IND.repeat(lvl) + ']';
  if (v && typeof v === 'object') return fmtObj(v, lvl);
  return JSON.stringify(v);
}
function fmtObj(o, lvl){
  const pad = IND.repeat(lvl);
  const entries = Object.entries(o);
  const lines = entries.map(([k,v]) => pad + IND + esc(k) + ': ' + fmtAny(v, lvl+1));
  return '{\n' + lines.join(',\n') + '\n' + pad + '}';
}
function stringifyPrettyInline(arr){
  return '[\n' + arr.map(o => fmtObj(o, 1)).join(',\n') + '\n]';
}

/* ---------- Merge ---------- */
let baseClubs = [];
function clubKey(c){ return (c.official || c.common || '').toLowerCase().replace(/\s+/g,' ').trim(); }
function mergeClubs(existing, incoming, prefer){
  const map = new Map();
  for(const c of existing){
    const k = clubKey(c); if(!k) continue;
    map.set(k, JSON.parse(JSON.stringify(c)));
  }
  for(const c of incoming){
    const k = clubKey(c); if(!k) continue;
    if(map.has(k)){
      const old = map.get(k);
      const merged = (prefer === 'new') ? {...old, ...c} : {...c, ...old};
      const a1 = Array.isArray(old.aliases) ? old.aliases : [];
      const a2 = Array.isArray(c.aliases) ? c.aliases : [];
      const aliases = [...new Set([...a1, ...a2])];
      if(aliases.length) merged.aliases = aliases;
      map.set(k, merged);
    }else{
      map.set(k, c);
    }
  }
  return [...map.values()].sort((a,b)=> (a.common||a.official||'').localeCompare(b.common||b.official||''));
}

/* ---------- UI ---------- */
const $ = id => document.getElementById(id);
const file = $('file'), csv = $('csv'), out = $('out'), countEl=$('count');
const convertBtn = $('convertBtn'), downloadBtn=$('downloadBtn'), copyBtn=$('copyBtn');
const wikiCB = $('wikicb'), crestOnlyCB=$('crestOnly'), wkBox=$('wkBox'), wkCount=$('wkCount'), wkBar=$('wkBar');
const errorsEl = $('errors'), sampleBtn = $('sampleBtn');
const jsonFile = $('jsonFile'), loadJsonBtn=$('loadJsonBtn'), clearBaseBtn=$('clearBaseBtn');
const jsonPaste = $('jsonPaste'), loadPasteBtn=$('loadPasteBtn');
const baseCount = $('baseCount'), autoMerge = $('autoMerge'), preferSelect = $('preferSelect');

let jsonData = [];
let jsonText  = '[]';

file.addEventListener('change', async () => {
  const f = file.files[0]; if(!f) return;
  csv.value = await f.text();
});
sampleBtn.addEventListener('click', () => {
  csv.value = `Arsenal,Arsenal,,Gunners|Arsenal FC,Arsenal F.C.
Aston Villa,Aston Villa,,Villa,Q18772`;
});

loadJsonBtn.addEventListener('click', async () => {
  const f = jsonFile.files?.[0]; if(!f){ alert('Choose a JSON file first.'); return; }
  try{
    const txt = await f.text(); const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('Root must be an array');
    baseClubs = arr; baseCount.textContent = baseClubs.length;
    alert('Loaded ' + baseClubs.length + ' clubs from file.');
  }catch(e){ alert('Invalid JSON: ' + e.message); }
});
loadPasteBtn.addEventListener('click', () => {
  try{
    const txt = jsonPaste.value.trim(); if(!txt){ alert('Paste some JSON first.'); return; }
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('Root must be an array');
    baseClubs = arr; baseCount.textContent = baseClubs.length;
    alert('Loaded ' + baseClubs.length + ' clubs from pasted JSON.');
  }catch(e){ alert('Invalid JSON: ' + e.message); }
});
clearBaseBtn.addEventListener('click', () => { baseClubs = []; baseCount.textContent = 0; });

function uniqueOrdered(arr){
  const seen = new Set(), out=[]; 
  for(const x of arr){ const key=(x||'').toLowerCase(); if(!key) continue; if(!seen.has(key)){ seen.add(key); out.push(x); } }
  return out;
}

convertBtn.addEventListener('click', async () => {
  errorsEl.innerHTML = '';
  out.textContent = '// Converting…';
  countEl.textContent = '0';
  downloadBtn.disabled = true; copyBtn.disabled = true;

  const raw = csv.value.trim();
  if(!raw){ out.textContent = '// Paste CSV first'; return; }

  // Parse CSV
  const rows = parseCSV(raw);
  if(rows.length < 1){ out.textContent = '// No rows found'; return; }

  // Header detection
  let headers, dataRows, headerWasPresent;
  if(looksLikeHeader(rows[0])){ headers=rows[0]; dataRows=rows.slice(1); headerWasPresent=true; }
  else { headers=DEFAULT_HEADERS.slice(); dataRows=rows; headerWasPresent=false; }

  let incoming = [], msgs=[];
  dataRows.forEach((r, i) => {
    const lineNo = i + (headerWasPresent ? 2 : 1);
    const {obj, errors} = toObj(headers, r, lineNo);
    if(Object.keys(obj).length) incoming.push(obj);
    if(errors.length) msgs.push(...errors);
  });

  // Auto-fetch (crest-only by default via Wikidata P154)
  if(wikiCB.checked){
    const missing = incoming.filter(d => !d.logo && (d.official || d.common || (d.aliases && d.aliases.length)));
    wkCount.textContent = missing.length;
    wkBar.style.width = missing.length ? '0%' : '100%';

    for(let i=0;i<missing.length;i++){
      const row = missing[i];
      const aliasList = Array.isArray(row.aliases) ? row.aliases : [];
      // candidates: wiki → aliases → official → common
      const candidates = uniqueOrdered([
        row.wiki?.trim(),
        ...aliasList,
        row.official || '',
        row.common   || ''
      ]).filter(Boolean);

      let crestUrl = null;
      for(const term of candidates){
        crestUrl = await resolveCrest(term);
        if(crestUrl) break;
      }

      if(crestUrl){
        row.logo = crestUrl;
      }else{
        msgs.push(`No crest (P154) found for “${row.official || row.common || aliasList[0] || 'unknown'}” — add a QID in the 'wiki' column or paste a logo URL manually.`);
      }
      wkBar.style.width = (((i+1)/missing.length)*100).toFixed(1) + '%';
    }
  }

  // Merge with loaded base if requested
  const prefer = preferSelect.value;
  let result = incoming;
  if(autoMerge.checked && baseClubs.length){
    const before = { base: baseClubs.length, incoming: incoming.length };
    result = mergeClubs(baseClubs, incoming, prefer);
    msgs.unshift(`Merged base ${before.base} + new ${before.incoming} → total ${result.length} (prefer ${prefer}).`);
  }else if(baseClubs.length && !autoMerge.checked){
    msgs.unshift('Loaded base detected — enable “Auto-merge on Convert” to combine.');
  }

  // Drop helper field 'wiki' from final output
  jsonData = result.map(({wiki, ...rest}) => rest);

  jsonText = stringifyPrettyInline(jsonData);
  out.textContent = jsonText;
  countEl.textContent = jsonData.length;
  downloadBtn.disabled = jsonData.length===0;
  copyBtn.disabled = jsonData.length===0;

  if(msgs.length){
    errorsEl.innerHTML = msgs.map(m=>{
      const cls = /No crest|No logo|missing|must|error/i.test(m)?'warn':'good';
      return `<li class="${cls}">${m}</li>`;
    }).join('');
  } else if(!headerWasPresent){
    errorsEl.innerHTML = `<li class="good">No header detected — assumed <code>common, official, logo, aliases</code>.</li>`;
  }

  // Enable buttons with latest string
  downloadBtn.onclick = () => {
    const blob = new Blob([jsonText], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'clubs.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };
  copyBtn.onclick = async () => {
    try{
      await navigator.clipboard.writeText(jsonText);
      copyBtn.textContent = 'Copied!';
      setTimeout(()=>copyBtn.textContent='Copy JSON',1200);
    }catch(e){ alert('Copy failed: ' + e); }
  };
});
</script>
</body>
</html>
